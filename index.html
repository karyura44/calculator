<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="theme-color" content="#2e8b57" />
		<meta
			name="description"
			content="Калькулятор стоимости забора с возможностью работы офлайн"
		/>

		<!-- PWA мета-теги -->
		<link rel="manifest" href="manifest.json" />
		<link rel="apple-touch-icon" href="./images/icon-192.png" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="apple-mobile-web-app-title" content="Калькулятор забора" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="application-name" content="Калькулятор забора" />
		<meta name="msapplication-starturl" content="/" />
		<meta name="msapplication-TileColor" content="#2e8b57" />
		<meta name="msapplication-TileImage" content="./images/icon-192.png" />

		<title>Калькулятор забора</title>

		<script>
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					navigator.serviceWorker
						.register('./sw.js')
						.then(registration => {
							console.log(
								'ServiceWorker успешно зарегистрирован:',
								registration
							)
						})
						.catch(err => {
							console.log('Ошибка регистрации ServiceWorker:', err)
						})
				})
			}
		</script>

		<!-- Скрипты -->
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap"
			rel="stylesheet"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<style>
			:root {
				--primary-green: #2e8b57;
				--dark-green: #006400;
				--light-green: #98fb98;
				--background: #f0fff0;
				--text-dark: #228b22;
				--button-hover: #3cb371;
				--button-active: #2e8b57;
				--button-shadow: rgba(46, 139, 87, 0.2);
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			html,
			body {
				height: 100%;
				margin: 0;
				padding: 0;
				background: var(--background);
				font-family: Arial, sans-serif;
				line-height: 1.6;
				overflow-y: auto;
			}

			body {
				padding: 15px;
				min-height: 100vh;
			}

			.t-calc-container {
				height: 100%;
				overflow-y: auto;
			}

			.wrapper {
				max-width: 1400px;
				margin: 0 auto;
				background: white;
				padding: 20px;
				border-radius: 10px;
				box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
				margin-bottom: 20px;
			}

			h1 {
				color: var(--dark-green);
				margin-bottom: 20px;
				font-size: 1.5rem;
				text-align: center;
			}

			.calc__row {
				display: flex;
				gap: 12px;
				margin: 12px 0;
				flex-wrap: wrap;
			}

			.calc__rowItem {
				flex: 1 1 300px;
				padding: 15px;
				background: #f8fff8;
				border-radius: 8px;
				border: 1px solid var(--light-green);
				min-width: 250px;
			}

			input,
			select {
				width: 100%;
				padding: 10px;
				margin: 8px 0;
				border: 1px solid var(--primary-green);
				border-radius: 6px;
				font-size: 1rem;
			}

			.stat-col {
				padding: 15px;
				background: #f8fff8;
				border-radius: 8px;
				border: 1px solid var(--light-green);
				margin-bottom: 15px;
			}

			.stat-col h3 {
				color: var(--dark-green);
				margin-bottom: 20px;
				font-size: 1.5rem;
				text-align: left;
			}

			.statistic__table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 10px;
			}

			.statistic__table th,
			.statistic__table td {
				border: 1px solid #ddd;
				padding: 8px;
				text-align: left;
			}

			.statistic__table th {
				background-color: var(--primary-green);
				color: white;
				font-weight: bold;
			}

			.statistic__table tfoot {
				font-weight: bold;
				background-color: var(--light-green);
			}

			.statistic__table tfoot td {
				padding: 10px;
			}

			#stat_total {
				font-size: 1.8rem;
				color: var(--dark-green);
				font-weight: bold;
				text-align: center;
				margin-top: 20px;
				padding: 15px;
				background: var (--light-green);
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			}

			.statistic {
				display: grid;
				grid-template-columns: repeat(2, 1fr) 300px;
				gap: 20px;
				margin-top: 25px;
			}

			/* Установка размеров колонок */
			.statistic__table th:nth-child(1),
			.statistic__table td:nth-child(1) {
				width: 40%;
			}
			.statistic__table th:nth-child(2),
			.statistic__table td:nth-child(2) {
				width: 20%;
			}
			.statistic__table th:nth-child(3),
			.statistic__table td:nth-child(3) {
				width: 20%;
			}
			.statistic__table th:nth-child(4),
			.statistic__table td:nth-child(4) {
				width: 20%;
			}

			@media (max-width: 1200px) {
				.statistic {
					grid-template-columns: 1fr;
				}
			}

			@media (max-width: 768px) {
				.statistic__table {
					display: block;
					overflow-x: auto;
				}
			}

			.checkbox-container {
				display: flex;
				align-items: center;
				gap: 10px;
			}

			.checkbox-container input[type='checkbox'] {
				width: 20px;
				height: 20px;
				cursor: pointer;
			}

			.checkbox-container label {
				font-size: 1rem;
				color: var(--text-dark);
				cursor: pointer;
			}

			@media (max-width: 768px) {
				.calc__rowItem {
					flex: 1 1 100%;
				}

				.statistic__table th,
				.statistic__table td {
					font-size: 0.8rem;
					padding: 6px;
				}

				#stat_total {
					font-size: 1.5rem;
					padding: 10px;
				}

				.statistic__table {
					display: block;
					overflow-x: auto;
				}

				.stat-col {
					min-width: 100%;
				}

				.statistic {
					grid-template-columns: 1fr;
				}
			}

			@media (max-width: 480px) {
				.statistic__table th,
				.statistic__table td {
					font-size: 0.7rem;
					padding: 4px;
				}
			}

			.export-button {
				background-color: var(--primary-green);
				color: white;
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				cursor: pointer;
				font-size: 16px;
				font-weight: 600;
				transition: all 0.3s ease;
				box-shadow: 0 4px 6px var(--button-shadow);
				margin: 10px;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				gap: 8px;
				min-width: 180px;
			}

			.export-button:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 12px var(--button-shadow);
			}

			.export-button:active {
				transform: translateY(0);
				box-shadow: 0 2px 4px var(--button-shadow);
			}

			.export-button.pdf {
				background-color: #ff4136;
			}

			.export-button.reset {
				background-color: var(--primary-green);
			}

			.export-button.reset:hover {
				background-color: var(--button-hover);
			}

			.export-button i {
				font-size: 18px;
			}

			.export-buttons-container {
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				justify-content: center;
				padding: 20px;
				background: #f8fff8;
				border-radius: 10px;
				margin: 20px 0;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			@media (max-width: 768px) {
				.export-buttons-container {
					flex-direction: column;
					align-items: stretch;
					gap: 10px;
					padding: 15px;
				}

				.export-button {
					width: 100%;
					margin: 0;
				}
			}
		</style>
	</head>
	<body>
		<div class="t-calc-container">
			<div class="wrapper">
				<h1>Калькулятор стоимости забора</h1>

				<!-- Основные параметры -->
				<div class="calc__row">
					<div class="calc__rowItem">
						<label>Высота забора (м):</label>
						<select id="fence_height">
							<option value="1.5">1.5 м</option>
							<option value="1.8">1.8 м</option>
							<option value="2.0">2.0 м</option>
						</select>
					</div>
				</div>

				<!-- Выбор материала -->
				<div class="calc__row">
					<div class="calc__rowItem">
						<label>Длина забора (м):</label>
						<input type="number" id="fence_length" min="0" value="0" />
					</div>

					<div class="calc__rowItem">
						<label>Тип материала:</label>
						<select id="material_type">
							<option value="prof0">Профлист С-8 оцинк. 0.4мм</option>
							<option value="prof1">Профлист одност. 0.4мм</option>
							<option value="prof2">Профлист одност. 0.45мм</option>
							<option value="prof3">Профлист одност. 0.5мм</option>
							<option value="prof4">Профлист двухст. 0.4мм</option>
							<option value="prof5">Профлист двухст. 0.45мм</option>
							<option value="prof6">Профлист двухст. 0.5мм</option>
							<option value="euro0">Евроштакетник одност. 0.4мм</option>
							<option value="euro1">Евроштакетник одност. 0.45мм</option>
							<option value="euro2">Евроштакетник двухст. 0.4мм</option>
							<option value="euro3">Евроштакетник двухст. 0.45мм</option>
							<option value="rabica">Сетка Рабица</option>
							<option value="3d">3D панель</option>
						</select>
					</div>
				</div>

				<!-- Добавляем контейнер для полей длины после выбора материалов -->
				<div id="length-inputs-container" class="calc__row"></div>

				<!-- Контейнер для полей длины материалов -->
				<div class="calc__row" id="material-lengths-container">
					<!-- Сюда будут добавляться поля длины -->
				</div>

				<!-- Дополнительные параметры -->
				<div class="calc__row">
					<div class="calc__rowItem">
						<label>Тип столба:</label>
						<select id="post_type">
							<option value="post1">Столб 60х60 h 3м</option>
							<option value="post2">Столб 60Х40 h 3м</option>
							<option value="post3">Столб кирпичный</option>
						</select>
					</div>

					<div class="calc__rowItem">
						<label>Покраска:</label>
						<select id="painting_type">
							<option value="0">Без покраски</option>
							<option value="1">Грунт ГФ-021</option>
							<option value="2">Краска Dalli</option>
							<option value="3">Грунтовка + краска</option>
						</select>
					</div>
				</div>

				<!-- Ворота и калитки -->
				<div class="calc__row">
					<div class="calc__rowItem">
						<label>Распашные ворота (шт):</label>
						<input type="number" id="swing_gate" value="0" min="0" />
					</div>
					<div class="calc__rowItem">
						<label>Откатные ворота (шт):</label>
						<input type="number" id="sliding_gate" value="0" min="0" />
					</div>
					<div class="calc__rowItem">
						<label>Калитки (шт):</label>
						<input type="number" id="wicket" value="0" min="0" />
					</div>
				</div>

				<!-- Дополнительные услуги -->
				<div class="calc__row">
					<div class="calc__rowItem">
						<label>Доставка:</label>
						<select id="delivery_type">
							<option value="3500">до 100 км</option>
							<option value="5000">от 100 до 150 км</option>
							<option value="7000">свыше 150 км</option>
						</select>
						<label style="margin-top: 10px">Количество рейсов:</label>
						<input type="number" id="delivery_count" value="1" min="1" />
					</div>

					<div class="calc__rowItem">
						<div class="checkbox-container">
							<input type="checkbox" id="automation" />
							<label for="automation">Автоматика</label>
						</div>
					</div>
				</div>

				<!-- Блок результатов -->
				<div class="statistic">
					<div class="stat-col" id="stat-col-materials">
						<h3>Материалы</h3>
						<div id="stat_materials">
							<table class="statistic__table">
								<thead>
									<tr>
										<th>Наименование</th>
										<th>Кол-во</th>
										<th>Цена</th>
										<th>Сумма</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div class="total-box"></div>
						</div>
					</div>

					<div class="stat-col" id="stat-col-works">
						<h3>Работы</h3>
						<div id="stat_works">
							<table class="statistic__table">
								<thead>
									<tr>
										<th>Наименование</th>
										<th>Кол-во</th>
										<th>Цена</th>
										<th>Сумма</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div class="total-box"></div>
						</div>
					</div>

					<div class="stat-col">
						<h3>Итого</h3>
						<div id="stat_total"><strong></strong></div>
					</div>
				</div>

				<!-- Кнопки экспорта -->
				<div class="export-buttons-container">
					<button class="export-button pdf" onclick="exportToPDF()">
						<i class="fas fa-file-pdf"></i>
						Скачать в PDF
					</button>
					<button class="export-button reset" onclick="resetAndContinue()">
						<i class="fas fa-redo"></i>
						Очистить
					</button>
				</div>

				<!-- Кнопка для установки PWA -->
				<button
					id="installPWA"
					style="
						display: none;
						position: fixed;
						bottom: 20px;
						right: 20px;
						padding: 10px 20px;
						background-color: var(--primary-green);
						color: white;
						border: none;
						border-radius: 5px;
						cursor: pointer;
					"
				>
					Установить приложение
				</button>

				<script>
					let deferredPrompt

					window.addEventListener('beforeinstallprompt', e => {
						console.log('Событие beforeinstallprompt вызвано') // Отладочный вывод
						e.preventDefault()
						deferredPrompt = e
						const installButton = document.getElementById('installPWA')
						installButton.style.display = 'block'

						installButton.addEventListener('click', () => {
							console.log('Кнопка установки нажата') // Отладочный вывод
							deferredPrompt.prompt()
							deferredPrompt.userChoice.then(choiceResult => {
								if (choiceResult.outcome === 'accepted') {
									console.log('PWA установлено')
								} else {
									console.log('PWA установка отклонена')
								}
								deferredPrompt = null
							})
						})
					})

					window.addEventListener('appinstalled', () => {
						console.log('PWA установлено') // Отладочный вывод
						document.getElementById('installPWA').style.display = 'none'
					})
				</script>
			</div>

			<script>
				const prices = {
					materials: {
						prof0: {
							name: 'Профлист С-8 оцинк. 0.4мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 850, 1.8: 980, 2.0: 1100 },
							work: 600,
						},
						prof1: {
							name: 'Профлист одност. 0.4мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 960, 1.8: 1150, 2.0: 1280 },
							work: 600,
						},
						prof2: {
							name: 'Профлист одност. 0.45мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 1050, 1.8: 1260, 2.0: 1400 },
							work: 600,
						},
						prof3: {
							name: 'Профлист одност. 0.5мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 1150, 1.8: 1400, 2.0: 1550 },
							work: 600,
						},
						prof4: {
							name: 'Профлист двухст. 0.4мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 1070, 1.8: 1300, 2.0: 1420 },
							work: 600,
						},
						prof5: {
							name: 'Профлист двухст. 0.45мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 1150, 1.8: 1400, 2.0: 1550 },
							work: 600,
						},
						prof6: {
							name: 'Профлист двухст. 0.5мм',
							type: 'лист',
							width: 1.15,
							prices: { 1.5: 1250, 1.8: 1500, 2.0: 1655 },
							work: 600,
						},
						euro0: {
							name: 'Евроштакетник одност. 0.4мм',
							type: 'штакетник',
							prices: { 1.5: 125, 1.8: 150, 2.0: 165 },
							work: 800,
						},
						euro1: {
							name: 'Евроштакетник одност. 0.45мм',
							type: 'штакетник',
							prices: { 1.5: 140, 1.8: 165, 2.0: 180 },
							work: 800,
						},
						euro2: {
							name: 'Евроштакетник двухст. 0.4мм',
							type: 'штакетник',
							prices: { 1.5: 145, 1.8: 175, 2.0: 190 },
							work: 1000,
						},
						euro3: {
							name: 'Евроштакетник двухст. 0.45мм',
							type: 'штакетник',
							prices: { 1.5: 155, 1.8: 185, 2.0: 205 },
							work: 1000,
						},
						rabica: {
							name: 'Сетка Рабица',
							type: 'рулон',
							price: { 1.5: 1800, 1.8: 2160, 2.0: 2400 },
							work: 400,
						},
						'3d': {
							name: '3D панель',
							type: 'секция',
							width: 2.5,
							price: { 1.5: 1750, 1.8: 1900, 2.0: 2200 },
							work: 600,
						},
						lags: {
							name: 'Лаги',
							type: 'м.п.',
							price: 120,
						},
					},
					gates: {
						swing: { material: 15000, work: 4000 },
						sliding: { material: 50000, work: 20000 },
						wicket: { material: 10000, work: 2000 },
					},
					automation: { material: 35000, work: 15000 },
					posts: {
						post1: { price: 900, name: 'Столб 60х60 h 3м' },
						post2: { price: 800, name: 'Столб 60Х40 h 3м' },
						post3: { price: 28000, name: 'Столб кирпичный' },
					},
					painting: {
						primer: 30,
						paint: 70,
					},
					lags: 120,
					stretching: 100,
					screw: 70,
				}

				function calculatePaintingCost(
					length,
					height,
					postCount,
					lagCount,
					swingGate,
					slidingGate,
					wicket,
					paintingType
				) {
					let totalLength = 0;

					const postType = $('#post_type').val();
					if (postType !== 'post3') {
						totalLength += postCount * 3;
					}

					const materialTypes = $('#material_type').val() || [];
					let lagFenceLength = 0;
					materialTypes.forEach(materialType => {
						if (materialType.startsWith('prof') || materialType.startsWith('euro')) {
							lagFenceLength += parseFloat($('.material-length[data-material="' + materialType + '"]').val()) || 0;
						}
					});

					if (lagFenceLength > 0) {
						totalLength += lagFenceLength * 2;
					}

					return { totalLength, paintingCost: totalLength * (paintingType === 1 ? prices.painting.primer : paintingType === 2 ? prices.painting.paint : paintingType === 3 ? prices.painting.primer + prices.painting.paint : 0) };
				}
			</script>
		</div>
	</body>
</html>
